<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZONA GAMER | CONTROL PANEL</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff0055;
            --bg: #0a0a0f;
            --card: #151520;
            --text: #ffffff;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Rajdhani', sans-serif; background: var(--bg); color: var(--text); display: flex; min-height: 100vh; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px; height: 100vh; background: #000; border-right: 2px solid var(--primary);
            position: fixed; left: -260px; transition: 0.3s; z-index: 1000;
        }
        .sidebar.active { left: 0; }
        .menu-btn { position: fixed; top: 20px; left: 20px; font-size: 1.5rem; cursor: pointer; color: var(--primary); z-index: 1100; background: var(--card); padding: 5px 15px; border-radius: 5px; border: 1px solid var(--primary); }

        .nav-link { padding: 15px 20px; display: block; color: white; text-decoration: none; border-bottom: 1px solid #111; cursor: pointer; }
        .nav-link:hover { background: var(--primary); }

        /* --- CONTENIDO --- */
        main { flex-grow: 1; padding: 80px 20px; width: 100%; }
        .section { display: none; max-width: 900px; margin: auto; }
        .section.active { display: block; }

        .admin-card { background: var(--card); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        h3 { font-family: 'Orbitron'; color: var(--primary); margin-bottom: 15px; text-transform: uppercase; }

        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #444; color: white; border-radius: 5px; }
        .btn-admin { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-family: 'Orbitron'; font-weight: bold; width: 100%; margin-top: 10px; }
        
        /* --- TABLAS Y BADGES --- */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #222; }
        th { color: var(--primary); font-family: 'Orbitron'; font-size: 0.7rem; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .status-active { background: var(--success); }
        .status-banned { background: var(--danger); }
        .status-suspended { background: var(--warning); }

        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

    <div class="menu-btn" onclick="toggleSidebar()">‚ò∞</div>

    <nav class="sidebar" id="sidebar">
        <div style="padding: 40px 20px; text-align: center;">
            <h2 style="color: var(--primary); font-family: 'Orbitron';">ZONA ADMIN</h2>
        </div>
        <div class="nav-link" onclick="showSection('sec-publicar')">üì¢ Publicaciones</div>
        <div class="nav-link" onclick="showSection('sec-ganadores')">üèÜ Dar Ganadores</div>
        <div class="nav-link" onclick="showSection('sec-usuarios')">üë• Usuarios</div>
        <div class="nav-link" onclick="showSection('sec-ajustes')">‚öôÔ∏è Ajustes Jugadores</div>
    </nav>

    <main>
        <div id="sec-publicar" class="section active">
            <h3>Crear Nuevo Torneo</h3>
            <div class="admin-card">
                <input type="text" id="t-nombre" placeholder="Nombre del Torneo">
                <textarea id="t-detalles" placeholder="Reglas, requisitos y horarios..."></textarea>
                <div class="grid-3">
                    <input type="number" id="pts-1" placeholder="Pts 1er">
                    <input type="number" id="pts-2" placeholder="Pts 2do">
                    <input type="number" id="pts-3" placeholder="Pts 3er">
                </div>
                <input type="number" id="pts-participacion" placeholder="Pts participaci√≥n (Resto)" value="2">
                <button class="btn-admin" onclick="publicarTorneo()">PUBLICAR TORNEO</button>
            </div>
        </div>

        <div id="sec-ganadores" class="section">
            <h3>Asignar Podio y Repartir Puntos</h3>
            <div class="admin-card">
                <label>ü•á 1er Puesto</label>
                <select id="sel-p1" class="user-list-select"></select>
                <label>ü•à 2do Puesto</label>
                <select id="sel-p2" class="user-list-select"></select>
                <label>ü•â 3er Puesto</label>
                <select id="sel-p3" class="user-list-select"></select>
                <button class="btn-admin" style="background: var(--success);" onclick="repartirPuntosGral()">FINALIZAR Y REPARTIR</button>
                <p style="font-size: 0.8rem; color: #888; margin-top: 10px;">* El resto de usuarios activos recibir√° los puntos de participaci√≥n autom√°ticamente.</p>
            </div>
        </div>

        <div id="sec-usuarios" class="section">
            <h3>Gesti√≥n de Estado</h3>
            <div class="admin-card">
                <table>
                    <thead>
                        <tr>
                            <th>NICK</th>
                            <th>ESTADO</th>
                            <th>ACCI√ìN</th>
                        </tr>
                    </thead>
                    <tbody id="table-status"></tbody>
                </table>
            </div>
        </div>

        <div id="sec-ajustes" class="section">
            <h3>Editar Puntos Manualmente</h3>
            <div class="admin-card">
                <select id="sel-edit-user" class="user-list-select"></select>
                <input type="number" id="new-points" placeholder="Nuevos Puntos">
                <button class="btn-admin" onclick="actualizarPuntosManual()">ACTUALIZAR PUNTOS</button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, increment, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAh6MqrL2KvhTfeXpEYvRNvKP-6vApMnAg",
            authDomain: "zona-gamer-live.firebaseapp.com",
            projectId: "zona-gamer-live",
            storageBucket: "zona-gamer-live.firebasestorage.app",
            messagingSenderId: "458669601177",
            appId: "1:458669601177:web:9b45b6f259d8b1aa9ee308"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // NAVEGACI√ìN
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
        window.showSection = (id) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            toggleSidebar();
        };

        // PUBLICAR TORNEO
        window.publicarTorneo = async () => {
            const nombre = document.getElementById('t-nombre').value;
            if(!nombre) return alert("Nombre obligatorio");
            
            await setDoc(doc(db, "tournaments", "activo"), {
                nombre,
                detalles: document.getElementById('t-detalles').value,
                puntos: [
                    parseInt(document.getElementById('pts-1').value) || 0,
                    parseInt(document.getElementById('pts-2').value) || 0,
                    parseInt(document.getElementById('pts-3').value) || 0
                ],
                puntos_extra: parseInt(document.getElementById('pts-participacion').value) || 2,
                fecha: new Date()
            });
            alert("Torneo publicado");
        };

        // CARGAR USUARIOS EN TIEMPO REAL
        const userCache = [];
        onSnapshot(collection(db, "users"), (snapshot) => {
            const selects = document.querySelectorAll('.user-list-select');
            const tableStatus = document.getElementById('table-status');
            
            userCache.length = 0;
            let options = '<option value="">Seleccionar Usuario...</option>';
            tableStatus.innerHTML = "";

            snapshot.forEach(snap => {
                const user = { id: snap.id, ...snap.data() };
                userCache.push(user);
                
                options += `<option value="${user.id}">${user.username}</option>`;
                
                tableStatus.innerHTML += `
                    <tr>
                        <td>${user.username}</td>
                        <td><span class="badge ${getStatusClass(user.status)}">${user.status || 'active'}</span></td>
                        <td>
                            <button onclick="cambiarEstado('${user.id}', 'banned')" style="color:red">Ban</button> |
                            <button onclick="suspender('${user.id}')" style="color:orange">Suspm</button> |
                            <button onclick="cambiarEstado('${user.id}', 'active')" style="color:green">Act</button>
                        </td>
                    </tr>
                `;
            });
            selects.forEach(s => s.innerHTML = options);
        });

        const getStatusClass = (s) => {
            if(s === 'banned') return 'status-banned';
            if(s === 'suspended') return 'status-suspended';
            return 'status-active';
        }

        // REPARTIR PUNTOS A TODOS
        window.repartirPuntosGral = async () => {
            const p1 = document.getElementById('sel-p1').value;
            const p2 = document.getElementById('sel-p2').value;
            const p3 = document.getElementById('sel-p3').value;
            
            const v1 = parseInt(document.getElementById('pts-1').value) || 0;
            const v2 = parseInt(document.getElementById('pts-2').value) || 0;
            const v3 = parseInt(document.getElementById('pts-3').value) || 0;
            const vResto = parseInt(document.getElementById('pts-participacion').value) || 2;

            if(!p1) return alert("M√≠nimo elige el 1er puesto");

            for(let user of userCache) {
                let suma = vResto;
                if(user.id === p1) suma = v1;
                else if(user.id === p2) suma = v2;
                else if(user.id === p3) suma = v3;

                await updateDoc(doc(db, "users", user.id), { points: increment(suma) });
            }
            alert("¬°Puntos repartidos a toda la comunidad!");
        };

        // BANEOS Y SUSPENSIONES
        window.cambiarEstado = async (uid, estado) => {
            await updateDoc(doc(db, "users", uid), { status: estado });
            alert("Estado actualizado");
        };

        window.suspender = async (uid) => {
            const dias = prompt("¬øCu√°ntos d√≠as de suspensi√≥n?");
            if(!dias) return;
            // Aqu√≠ podr√≠as guardar una fecha de desbloqueo, por ahora solo marcamos el estado
            await updateDoc(doc(db, "users", uid), { 
                status: 'suspended',
                unlockDate: Date.now() + (dias * 24 * 60 * 60 * 1000)
            });
            alert("Usuario suspendido");
        };

        window.actualizarPuntosManual = async () => {
            const uid = document.getElementById('sel-edit-user').value;
            const pts = parseInt(document.getElementById('new-points').value);
            if(!uid || isNaN(pts)) return alert("Datos incompletos");
            await updateDoc(doc(db, "users", uid), { points: pts });
            alert("Puntos actualizados manualmente");
        };
    </script>
</body>
</html>
