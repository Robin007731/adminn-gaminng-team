<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZONA GAMER | Master Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Orbitron:wght@700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #030508; --card: #0d1117; --neon: #00f2ff; --text: #e0e6ed; 
            --success: #39FF14; --gold: #ffcc00; --error: #ff3131; --border: #1a1f26;
        }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Rajdhani', sans-serif; }

        /* --- NOTIFICACIONES --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { background: #000; border: 1px solid var(--neon); color: #fff; padding: 12px 20px; margin-bottom: 10px; font-family: 'Fira Code'; font-size: 0.8rem; border-radius: 4px; animation: slide 0.3s ease; }
        @keyframes slide { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- UI ELEMENTS --- */
        header { background: var(--card); padding: 15px 30px; border-bottom: 2px solid var(--neon); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .container { max-width: 1300px; margin: 20px auto; padding: 0 15px; display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        @media (max-width: 950px) { .container { grid-template-columns: 1fr; } }

        .card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .card-h { font-family: 'Orbitron'; font-size: 0.7rem; color: var(--neon); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; }

        input, textarea { width: 100%; padding: 10px; background: #000; border: 1px solid var(--border); color: #fff; font-family: 'Fira Code'; font-size: 0.8rem; margin-bottom: 10px; border-radius: 4px; }
        .btn { width: 100%; padding: 12px; border: none; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.7rem; border-radius: 4px; transition: 0.2s; }
        .btn-neon { background: var(--neon); color: #000; }
        .btn-neon:hover { filter: brightness(1.2); box-shadow: 0 0 10px var(--neon); }

        /* --- TABLE --- */
        table { width: 100%; border-collapse: collapse; font-family: 'Fira Code'; font-size: 0.8rem; }
        th { text-align: left; padding: 10px; color: #444; font-size: 0.6rem; font-family: 'Orbitron'; border-bottom: 1px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid #0a0e14; }
        .action-btn { background: #111; border: 1px solid #222; color: #fff; padding: 4px 8px; cursor: pointer; font-size: 0.6rem; margin-right: 2px; border-radius: 3px; }
        .action-btn:hover { border-color: var(--neon); color: var(--neon); }

        #loading { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; color: var(--neon); }
    </style>
</head>
<body>

    <div id="loading">CONECTANDO AL SATÉLITE...</div>
    <div id="toast-container"></div>

    <header>
        <div style="font-family:'Orbitron'; font-size: 1rem;">ZONA_<span style="color:var(--neon)">ADMIN</span></div>
        <button class="action-btn" onclick="window.logout()" style="color:var(--error); border-color:var(--error)">LOGOUT</button>
    </header>

    <div class="container">
        <aside>
            <div class="card">
                <div class="card-h">COLOR_SISTEMA</div>
                <input type="color" id="color-picker" onchange="window.updateColor(this.value)">
            </div>

            <div class="card">
                <div class="card-h">MENSAJE_GLOBAL</div>
                <textarea id="msg-text" rows="2" placeholder="Escribir mensaje de sistema..."></textarea>
                <button class="btn btn-neon" onclick="window.sendGlobalMsg()">BROADCAST</button>
            </div>

            <div class="card">
                <div class="card-h">NUEVA_MISIÓN</div>
                <input type="text" id="m-name" placeholder="Nombre Misión">
                <textarea id="m-desc" rows="2" placeholder="Descripción"></textarea>
                <button class="btn btn-neon" onclick="window.createMission()">DESPLEGAR</button>
            </div>
        </aside>

        <main>
            <div class="card">
                <div class="card-h">BASE_DATOS_USUARIOS <span id="count">0</span></div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>OPERATIVO</th>
                                <th>PUNTOS</th>
                                <th>WHATSAPP</th>
                                <th>ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="user-table"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, collection, query, orderBy, deleteDoc, increment, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAyGsnbyvxTEzvtgOXSmU_5Hj6gS6TOWKM",
            authDomain: "gaming-team-18b95.firebaseapp.com",
            projectId: "gaming-team-18b95",
            storageBucket: "gaming-team-18b95.appspot.com",
            messagingSenderId: "89183017486",
            appId: "1:89183017486:web:18b6258a2bf5c0bde97a5f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- NOTIFICACIÓN ---
        window.notify = (msg) => {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            container.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        };

        // --- AUTH & SEGURIDAD ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "usuarios", user.uid));
                if (userDoc.exists() && userDoc.data().admin === true) {
                    document.getElementById('loading').style.display = 'none';
                    initAdminData();
                } else {
                    alert("ACCESO DENEGADO");
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // --- CARGA DE DATOS ---
        function initAdminData() {
            // Tabla de Usuarios
            onSnapshot(collection(db, "usuarios"), (snap) => {
                const tbody = document.getElementById('user-table');
                document.getElementById('count').innerText = snap.size;
                tbody.innerHTML = "";
                snap.forEach(d => {
                    const u = d.data();
                    tbody.innerHTML += `
                        <tr>
                            <td style="font-weight:bold">${u.nick} ${u.verificado ? '✅' : ''}</td>
                            <td style="color:var(--success)">${u.puntos} XP</td>
                            <td style="color:#555">${u.whatsapp || '---'}</td>
                            <td>
                                <button class="action-btn" onclick="window.addXP('${d.id}', 100)">+100</button>
                                <button class="action-btn" onclick="window.toggleV('${d.id}', ${u.verificado})">VERIF</button>
                                <button class="action-btn" onclick="window.delUser('${d.id}')" style="color:var(--error)">ELIM</button>
                            </td>
                        </tr>
                    `;
                });
            });

            // Config Global
            onSnapshot(doc(db, "config", "global"), (d) => {
                if(d.exists()) {
                    const color = d.data().colorNeon;
                    document.getElementById('color-picker').value = color;
                    document.documentElement.style.setProperty('--neon', color);
                }
            });
        }

        // --- FUNCIONES GLOBALES (Ancladas a window) ---
        window.addXP = async (uid, val) => {
            await updateDoc(doc(db, "usuarios", uid), { puntos: increment(val) });
            notify("PUNTOS ACTUALIZADOS");
        };

        window.toggleV = async (uid, cur) => {
            await updateDoc(doc(db, "usuarios", uid), { verificado: !cur });
            notify("ESTADO VERIFICACIÓN CAMBIADO");
        };

        window.delUser = async (uid) => {
            if(confirm("¿ELIMINAR DEFINITIVAMENTE?")) {
                await deleteDoc(doc(db, "usuarios", uid));
                notify("USUARIO ELIMINADO");
            }
        };

        window.updateColor = async (color) => {
            await setDoc(doc(db, "config", "global"), { colorNeon: color }, { merge: true });
            notify("COLOR DE INTERFAZ ACTUALIZADO");
        };

        window.sendGlobalMsg = async () => {
            const txt = document.getElementById('msg-text').value;
            if(!txt) return;
            await addDoc(collection(db, "chat_global"), {
                nick: "SYSTEM",
                text: txt.toUpperCase(),
                role: "admin",
                timestamp: serverTimestamp()
            });
            document.getElementById('msg-text').value = "";
            notify("MENSAJE GLOBAL ENVIADO");
        };

        window.createMission = async () => {
            const n = document.getElementById('m-name').value;
            const d = document.getElementById('m-desc').value;
            if(!n || !d) return notify("DATOS INCOMPLETOS");
            const mid = "M-" + Date.now();
            await setDoc(doc(db, "torneos", mid), {
                nombre: n, desc: d, inscritos_count: 0, jugadores: [], active: true
            });
            document.getElementById('m-name').value = "";
            document.getElementById('m-desc').value = "";
            notify("MISIÓN DESPLEGADA");
        };

        window.logout = () => signOut(auth).then(() => window.location.reload());

    </script>
</body>
</html>
