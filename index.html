<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARENA NEON | CONTROL TOTAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { background: #02040a; color: white; font-family: 'Rajdhani', sans-serif; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
        .nav-item { width: 100%; text-align: left; padding: 15px 25px; font-size: 11px; font-weight: 800; text-transform: uppercase; transition: 0.3s; }
        .nav-item.active { border-left: 4px solid #f59e0b; color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .view { display: none; padding: 30px; }
        .view.active { display: block; }
        input { background: #000; border: 1px solid #334155; color: white; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="lock-screen" class="fixed inset-0 z-[9999] bg-black flex flex-col items-center justify-center p-6">
        <div id="loader-icon" class="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 id="lock-status" class="font-orbitron text-lg text-amber-500 animate-pulse">SISTEMA DE SEGURIDAD ACTIVADO</h2>
        <p id="lock-detail" class="text-zinc-500 text-xs mt-2 uppercase tracking-widest">Verificando nivel de acceso...</p>
        <button id="emergency-exit" onclick="window.location.href='index.html'" class="hidden mt-8 text-red-500 text-[10px] font-bold border border-red-500/30 px-4 py-2 rounded">CANCELAR Y VOLVER</button>
    </div>

    <div class="flex min-h-screen">
        <aside class="w-64 glass border-r border-white/10">
            <div class="p-8 border-b border-white/5">
                <h1 class="font-orbitron text-xl font-black">ADMIN<span class="text-amber-500">_NEON</span></h1>
            </div>
            <nav class="mt-4">
                <button onclick="showView('users')" id="n-users" class="nav-item active">üë§ Usuarios</button>
                <button onclick="showView('tourneys')" id="n-tourneys" class="nav-item">‚öîÔ∏è Torneos</button>
                <button onclick="showView('tickets')" id="n-tickets" class="nav-item">üì© Tickets</button>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto">
            <section id="v-users" class="view active">
                <h3 class="font-orbitron text-2xl mb-6 uppercase">Base de Datos</h3>
                <div class="glass rounded-xl p-4">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-zinc-500 text-[10px] uppercase">
                                <th class="p-2">Usuario</th>
                                <th class="p-2">XP</th>
                                <th class="p-2">Wins</th>
                                <th class="p-2">Admin</th>
                                <th class="p-2">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="user-list"></tbody>
                    </table>
                </div>
            </section>

            <section id="v-tourneys" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-orbitron text-2xl uppercase">Torneos</h3>
                    <button onclick="createNewTourney()" class="bg-amber-500 text-black font-bold px-4 py-2 rounded text-xs">NUEVA ARENA</button>
                </div>
                <div id="tourney-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </section>

            <section id="v-tickets" class="view">
                <h3 class="font-orbitron text-2xl mb-6 uppercase">Soporte</h3>
                <div id="ticket-list" class="space-y-4"></div>
            </section>
        </main>
    </div>

    <script>
        const _supa = supabase.createClient('https://qxvqxdsfcvdmanxtzmkn.supabase.co', 'sb_publishable_X2_itSXVSMUgkZeDLSE3KQ_HxD1Jf07');

        // --- SISTEMA DE SEGURIDAD REFORZADO ---
        async function runSecurityCheck() {
            const detail = document.getElementById('lock-detail');
            const exitBtn = document.getElementById('emergency-exit');
            
            // Timeout de emergencia: si en 7 segundos no carga, muestra bot√≥n de salida
            setTimeout(() => { 
                exitBtn.classList.remove('hidden');
                detail.innerText = "LA RESPUESTA EST√Å TARDANDO DEMASIADO...";
            }, 7000);

            try {
                detail.innerText = "CONECTANDO CON EL SERVIDOR...";
                const { data: { session }, error: authError } = await _supa.auth.getSession();
                
                if (authError || !session) {
                    window.location.href = 'index.html';
                    return;
                }

                detail.innerText = "VALIDANDO PERMISOS DE MANDO...";
                const { data: profile, error: profError } = await _supa.from('perfiles')
                    .select('is_admin')
                    .eq('id', session.user.id)
                    .single();

                if (profError || !profile || !profile.is_admin) {
                    alert("ACCESO DENEGADO: No tienes permisos de administrador.");
                    window.location.href = 'index.html';
                } else {
                    // TODO CORRECTO
                    document.getElementById('lock-screen').style.display = 'none';
                    loadUsers();
                }
            } catch (err) {
                detail.innerText = "ERROR CR√çTICO: " + err.message;
                console.error(err);
            }
        }

        // --- FUNCIONES DE NAVEGACION ---
        function showView(v) {
            document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            document.getElementById('v-' + v).classList.add('active');
            document.getElementById('n-' + v).classList.add('active');
            if(v === 'users') loadUsers();
            if(v === 'tourneys') loadTourneys();
            if(v === 'tickets') loadTickets();
        }

        // --- LOGICA DE DATOS ---
        async function loadUsers() {
            const { data } = await _supa.from('perfiles').select('*').order('xp', {ascending: false});
            if(!data) return;
            document.getElementById('user-list').innerHTML = data.map(u => `
                <tr class="border-b border-white/5 text-sm">
                    <td class="p-2 flex items-center gap-2"><img src="${u.avatar_url}" class="w-6 h-6 rounded-full"> ${u.nombre}</td>
                    <td class="p-2"><input type="number" value="${u.xp}" onchange="upd('${u.id}', 'xp', this.value)" class="w-16"></td>
                    <td class="p-2"><input type="number" value="${u.victorias}" onchange="upd('${u.id}', 'victorias', this.value)" class="w-16"></td>
                    <td class="p-2">${u.is_admin ? '‚úÖ' : '‚ùå'}</td>
                    <td class="p-2"><button onclick="ban('${u.id}', ${u.baneado})" class="text-[10px] ${u.baneado ? 'text-green-500' : 'text-red-500'} font-bold">${u.baneado ? 'REMITIR' : 'BANEAR'}</button></td>
                </tr>
            `).join('');
        }

        async function upd(id, field, val) {
            const obj = {}; obj[field] = parseInt(val);
            await _supa.from('perfiles').update(obj).eq('id', id);
        }

        async function ban(id, stat) {
            await _supa.from('perfiles').update({baneado: !stat}).eq('id', id);
            loadUsers();
        }

        async function loadTourneys() {
            const { data } = await _supa.from('torneos').select('*');
            document.getElementById('tourney-list').innerHTML = data.map(t => `
                <div class="glass p-4 rounded-xl flex justify-between items-center">
                    <div>
                        <p class="font-bold text-amber-500">${t.nombre}</p>
                        <p class="text-[10px] text-zinc-500 uppercase">${t.juego} | ${t.inscritos}/${t.capacidad}</p>
                    </div>
                    <button onclick="delT('${t.id}')" class="text-red-500 text-xs font-black">X</button>
                </div>
            `).join('');
        }

        async function createNewTourney() {
            const n = prompt("Nombre del Torneo:");
            const j = prompt("Juego:");
            if(n && j) {
                await _supa.from('torneos').insert({ nombre: n, juego: j, capacidad: 16, inscritos: 0 });
                loadTourneys();
            }
        }

        async function delT(id) {
            if(confirm("¬øBorrar torneo?")) {
                await _supa.from('torneos').delete().eq('id', id);
                loadTourneys();
            }
        }

        async function loadTickets() {
            const { data } = await _supa.from('tickets_soporte').select('*').order('created_at', {ascending: false});
            document.getElementById('ticket-list').innerHTML = data.map(tk => `
                <div class="glass p-4 rounded-xl border-l-2 ${tk.leido ? 'border-zinc-700 opacity-50' : 'border-amber-500'}">
                    <p class="text-xs font-bold text-amber-500 uppercase">${tk.asunto}</p>
                    <p class="text-sm mt-1">${tk.mensaje}</p>
                    <button onclick="read('${tk.id}')" class="text-[9px] mt-2 text-zinc-500 font-bold uppercase">Marcar le√≠do</button>
                </div>
            `).join('');
        }

        async function read(id) {
            await _supa.from('tickets_soporte').update({leido: true}).eq('id', id);
            loadTickets();
        }

        // EJECUTAR AL CARGAR
        runSecurityCheck();
    </script>
</body>
</html>
