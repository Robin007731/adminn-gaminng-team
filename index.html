<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZONA GAMER | Master Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #030507; --card: #0d1117; --neon: #00f2ff; --gold: #ffcc00; --text: #ffffff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Rajdhani', sans-serif; }
        
        nav { background: #000; padding: 20px; border-bottom: 2px solid var(--neon); display: flex; justify-content: space-between; align-items: center; }
        .container { padding: 20px; max-width: 1000px; margin: 0 auto; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #1f2937; }
        
        h2 { font-family: 'Orbitron'; color: var(--neon); font-size: 1rem; margin-top: 0; }
        
        input, textarea, select { 
            width: 100%; padding: 12px; margin: 10px 0; background: #000; 
            border: 1px solid #222; color: #fff; border-radius: 8px; 
        }
        
        button { 
            width: 100%; padding: 12px; border: none; border-radius: 8px; 
            font-family: 'Orbitron'; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .btn-add { background: var(--neon); color: #000; }
        .btn-gold { background: var(--gold); color: #000; margin-top: 10px; }

        /* Estilos del Chat en Admin */
        #admin-chat { height: 300px; overflow-y: auto; background: #000; padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 0.8rem; }
        .msg { margin-bottom: 8px; border-bottom: 1px solid #111; padding-bottom: 4px; }
        .msg-admin { color: var(--gold); border-left: 2px solid var(--gold); padding-left: 5px; }

        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #111; font-size: 0.9rem; }
    </style>
</head>
<body>

    <nav>
        <div style="font-family:'Orbitron';">ZONA GAMER <span style="color:var(--neon)">ADMIN</span></div>
        <button onclick="location.reload()" style="width:auto; padding:5px 15px; font-size:0.7rem;">REFRESCAR</button>
    </nav>

    <div class="container">
        <div class="grid">
            
            <div class="card">
                <h2>NUEVA MISIÓN</h2>
                <input type="text" id="m-nombre" placeholder="Nombre del Torneo/Misión">
                <textarea id="m-desc" placeholder="Descripción y Requisitos"></textarea>
                <button class="btn-add" onclick="crearMision()">PUBLICAR MISIÓN</button>
            </div>

            <div class="card">
                <h2>CHAT GLOBAL</h2>
                <div id="admin-chat"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="admin-msg" placeholder="Responder como Admin..." style="margin:0;">
                    <button class="btn-gold" onclick="sendAdminMessage()" style="width:auto; margin:0;">ENVIAR</button>
                </div>
            </div>

            <div class="card">
                <h2>OPERATIVOS (USUARIOS)</h2>
                <div id="user-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>

            <div class="card">
                <h2>CONFIGURACIÓN DEL SISTEMA</h2>
                <label>Color Neon (Hex):</label>
                <input type="color" id="conf-color" onchange="updateColor(this.value)">
                <p style="font-size:0.7rem; color:#555;">Este color cambiará la interfaz de todos los usuarios en tiempo real.</p>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, collection, onSnapshot, query, orderBy, limit, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAyGsnbyvxTEzvtgOXSmU_5Hj6gS6TOWKM",
            authDomain: "gaming-team-18b95.firebaseapp.com",
            projectId: "gaming-team-18b95",
            storageBucket: "gaming-team-18b95.appspot.com",
            messagingSenderId: "89183017486",
            appId: "1:89183017486:web:18b6258a2bf5c0bde97a5f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- CREAR MISIÓN ---
        window.crearMision = async () => {
            const nombre = document.getElementById('m-nombre').value;
            const desc = document.getElementById('m-desc').value;
            if(!nombre) return alert("Ponle un nombre");
            const id = "TOR-" + Date.now();
            await setDoc(doc(db, "torneos", id), {
                nombre, desc, estado: 'activo', inscritos_count: 0, jugadores: []
            });
            alert("Misión publicada!");
        };

        // --- CHAT ADMIN ---
        const qChat = query(collection(db, "chat_global"), orderBy("timestamp", "desc"), limit(30));
        onSnapshot(qChat, snap => {
            const box = document.getElementById('admin-chat');
            box.innerHTML = "";
            let msgs = [];
            snap.forEach(d => msgs.unshift(d.data()));
            msgs.forEach(m => {
                const isAdmin = m.role === 'admin';
                box.innerHTML += `<div class="msg ${isAdmin ? 'msg-admin' : ''}"><b>${m.nick}:</b> ${m.text}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });

        window.sendAdminMessage = async () => {
            const input = document.getElementById('admin-msg');
            if(!input.value) return;
            await addDoc(collection(db, "chat_global"), {
                nick: "ADMIN",
                text: input.value,
                role: 'admin',
                timestamp: serverTimestamp()
            });
            input.value = "";
        };

        // --- GESTIÓN DE USUARIOS ---
        onSnapshot(collection(db, "usuarios"), snap => {
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                list.innerHTML += `
                    <div class="user-item">
                        <span>${u.nick} (${u.puntos} pts)</span>
                        <div style="display:flex; gap:5px;">
                            <button onclick="sumarPuntos('${d.id}', 10)" style="width:30px; padding:2px; background:green;">+10</button>
                            <button onclick="hacerAdmin('${d.id}', ${!u.admin})" style="width:auto; padding:2px 5px; background:${u.admin ? 'red':'var(--gold)'}; font-size:0.6rem;">${u.admin ? 'QUITAR ADMIN':'HACER ADMIN'}</button>
                        </div>
                    </div>`;
            });
        });

        window.sumarPuntos = async (id, pts) => {
            await updateDoc(doc(db, "usuarios", id), { puntos: increment(pts) });
        };

        window.hacerAdmin = async (id, valor) => {
            await updateDoc(doc(db, "usuarios", id), { admin: valor });
            alert("Rango actualizado");
        };

        window.updateColor = async (color) => {
            await setDoc(doc(db, "config", "global"), { colorNeon: color }, { merge: true });
        };
    </script>
</body>
</html>
