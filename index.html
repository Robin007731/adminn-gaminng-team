<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARENA NEON | COMMAND CENTER</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --admin-gold: #f59e0b; --admin-red: #ef4444; --bg: #030508; }
        body { background: var(--bg); color: white; font-family: 'Rajdhani', sans-serif; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .sidebar-btn { width: 100%; text-align: left; padding: 12px 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; border-left: 3px solid transparent; }
        .sidebar-btn.active { background: rgba(245, 158, 11, 0.1); border-left-color: var(--admin-gold); color: var(--admin-gold); }
        .view-section { display: none; animation: slideIn 0.3s ease-out; }
        .view-section.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        
        input, select, textarea { background: #000 !important; border: 1px solid #334155 !important; color: white !important; padding: 10px; border-radius: 6px; font-size: 12px; }
        .btn-save { background: var(--admin-gold); color: black; font-family: 'Orbitron'; font-weight: 900; font-size: 10px; padding: 10px 20px; border-radius: 4px; transition: 0.3s; }
        .btn-save:hover { box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); transform: scale(1.02); }
    </style>
</head>
<body class="overflow-hidden">

    <div id="admin-lock" class="fixed inset-0 z-[9999] bg-black flex items-center justify-center text-center p-6">
        <div>
            <h1 class="font-orbitron text-4xl mb-4 text-red-600 animate-pulse">ACCESO RESTRINGIDO</h1>
            <p class="text-zinc-500 uppercase tracking-[0.5em] text-xs">Verificando Credenciales de Comando...</p>
        </div>
    </div>

    <div class="flex h-screen">
        <aside class="w-64 glass border-r border-white/5 flex flex-col">
            <div class="p-8 border-b border-white/5">
                <h2 class="font-orbitron text-xl font-black italic">ADMIN <span class="text-amber-500">NEON</span></h2>
            </div>
            <nav class="flex-1 py-6">
                <button onclick="changeView('users')" id="btn-users" class="sidebar-btn active">üë• Gesti√≥n de Usuarios</button>
                <button onclick="changeView('tournaments')" id="btn-tournaments" class="sidebar-btn">‚öîÔ∏è Control de Torneos</button>
                <button onclick="changeView('tickets')" id="btn-tickets" class="sidebar-btn">üì© Tickets Soporte</button>
                <button onclick="changeView('settings')" id="btn-settings" class="sidebar-btn">‚öôÔ∏è Ajustes Sistema</button>
            </nav>
            <div class="p-6">
                <button onclick="window.location.href='index.html'" class="text-[10px] font-bold text-zinc-500 uppercase hover:text-white">Volver a la Arena</button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto p-10">
            
            <section id="view-users" class="view-section active">
                <div class="flex justify-between items-center mb-10">
                    <h3 class="font-orbitron text-2xl font-black">BASE_DATOS_GUERREROS</h3>
                    <input type="text" id="user-search" onkeyup="searchUsers()" placeholder="BUSCAR POR NOMBRE..." class="w-64">
                </div>
                <div class="glass rounded-xl overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-white/5 text-[10px] uppercase font-black text-zinc-500">
                            <tr>
                                <th class="p-4">Guerrero</th>
                                <th class="p-4">XP Actual</th>
                                <th class="p-4">Wins</th>
                                <th class="p-4">Estado</th>
                                <th class="p-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="text-sm">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="view-tournaments" class="view-section">
                <div class="flex justify-between items-center mb-10">
                    <h3 class="font-orbitron text-2xl font-black">MAESTR√çA_DE_BATALLAS</h3>
                    <button onclick="openTourneyModal()" class="btn-save">Crear Nuevo Torneo</button>
                </div>
                <div id="admin-tourneys-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    </div>
            </section>

            <section id="view-tickets" class="view-section">
                <h3 class="font-orbitron text-2xl font-black mb-10">CENTRO_DE_SOPORTE</h3>
                <div id="tickets-list" class="space-y-4">
                    </div>
            </section>

        </main>
    </div>

    <div id="tourney-modal" class="fixed inset-0 bg-black/90 z-[5000] hidden flex items-center justify-center p-6">
        <div class="glass p-8 rounded-2xl w-full max-w-lg">
            <h4 class="font-orbitron text-lg mb-6">CONFIGURAR ARENA</h4>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="flex flex-col"><label class="text-[10px] uppercase font-bold text-zinc-500 mb-1">Nombre</label><input id="t-name" type="text" placeholder="Ej: COPA ORO"></div>
                <div class="flex flex-col"><label class="text-[10px] uppercase font-bold text-zinc-500 mb-1">Juego</label><input id="t-game" type="text" placeholder="FREE FIRE"></div>
                <div class="flex flex-col"><label class="text-[10px] uppercase font-bold text-zinc-500 mb-1">Capacidad</label><input id="t-cap" type="number" value="16"></div>
                <div class="flex flex-col"><label class="text-[10px] uppercase font-bold text-zinc-500 mb-1">Pre-inscritos</label><input id="t-ins" type="number" value="0"></div>
            </div>
            <div class="flex gap-4">
                <button onclick="saveTournament()" class="flex-1 btn-save">Publicar Torneo</button>
                <button onclick="closeTourneyModal()" class="px-6 text-xs uppercase font-bold">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const _supa = supabase.createClient('https://qxvqxdsfcvdmanxtzmkn.supabase.co', 'sb_publishable_X2_itSXVSMUgkZeDLSE3KQ_HxD1Jf07');

        // VERIFICACI√ìN DE SEGURIDAD
        async function checkAdmin() {
            const { data: { session } } = await _supa.auth.getSession();
            if(!session) return window.location.href = 'index.html';

            const { data: profile } = await _supa.from('perfiles').select('is_admin').eq('id', session.user.id).single();
            
            if(profile && profile.is_admin) {
                document.getElementById('admin-lock').style.display = 'none';
                loadUsers();
            } else {
                alert("NO TIENES PERMISOS DE COMANDANTE.");
                window.location.href = 'index.html';
            }
        }
        checkAdmin();

        // MOTOR DE VISTAS
        function changeView(view) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-' + view).classList.add('active');
            document.getElementById('btn-' + view).classList.add('active');
            
            if(view === 'users') loadUsers();
            if(view === 'tournaments') loadAdminTourneys();
            if(view === 'tickets') loadTickets();
        }

        // GESTI√ìN DE USUARIOS
        async function loadUsers() {
            const { data } = await _supa.from('perfiles').select('*').order('created_at', {ascending: false});
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = data.map(u => `
                <tr class="border-b border-white/5 hover:bg-white/5 transition">
                    <td class="p-4 flex items-center gap-3">
                        <img src="${u.avatar_url}" class="w-8 h-8 rounded-full">
                        <span class="font-bold">${u.nombre}</span>
                    </td>
                    <td class="p-4"><input type="number" value="${u.xp}" onchange="updateXp('${u.id}', this.value)" class="w-20 bg-transparent"></td>
                    <td class="p-4"><input type="number" value="${u.victorias}" onchange="updateWins('${u.id}', this.value)" class="w-20 bg-transparent"></td>
                    <td class="p-4">
                        <span class="${u.baneado ? 'text-red-500' : 'text-green-500'} font-black uppercase text-[10px]">
                            ${u.baneado ? 'BLOQUEADO' : 'ACTIVO'}
                        </span>
                    </td>
                    <td class="p-4 text-right">
                        <button onclick="toggleBan('${u.id}', ${u.baneado})" class="text-[9px] font-bold p-2 ${u.baneado ? 'bg-green-500/10 text-green-500' : 'bg-red-500/10 text-red-500'} rounded">
                            ${u.baneado ? 'DESBANEAR' : 'BANEAR'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function updateXp(id, val) { await _supa.from('perfiles').update({xp: parseInt(val)}).eq('id', id); }
        async function updateWins(id, val) { await _supa.from('perfiles').update({victorias: parseInt(val)}).eq('id', id); }
        async function toggleBan(id, current) {
            await _supa.from('perfiles').update({baneado: !current}).eq('id', id);
            loadUsers();
        }

        // GESTI√ìN DE TORNEOS
        function openTourneyModal() { document.getElementById('tourney-modal').classList.remove('hidden'); }
        function closeTourneyModal() { document.getElementById('tourney-modal').classList.add('hidden'); }

        async function saveTournament() {
            const n = document.getElementById('t-name').value;
            const j = document.getElementById('t-game').value;
            const c = document.getElementById('t-cap').value;
            const i = document.getElementById('t-ins').value;
            
            const { error } = await _supa.from('torneos').insert({ nombre: n, juego: j, capacidad: c, inscritos: i });
            if(!error) { closeTourneyModal(); loadAdminTourneys(); }
        }

        async function loadAdminTourneys() {
            const { data } = await _supa.from('torneos').select('*').order('created_at', {ascending: false});
            document.getElementById('admin-tourneys-list').innerHTML = data.map(t => `
                <div class="glass p-6 rounded-xl border-l-4 border-amber-500">
                    <h4 class="font-orbitron font-bold text-white mb-2">${t.nombre}</h4>
                    <p class="text-xs text-zinc-500 mb-4">${t.juego} | ${t.inscritos}/${t.capacidad} JUGADORES</p>
                    <div class="flex gap-2">
                        <button onclick="deleteTourney('${t.id}')" class="text-[9px] font-black text-red-500 p-2 bg-red-500/10 rounded uppercase">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        async function deleteTourney(id) {
            if(confirm("¬øELIMINAR ESTE TORNEO?")) {
                await _supa.from('torneos').delete().eq('id', id);
                loadAdminTourneys();
            }
        }

        // TICKETS
        async function loadTickets() {
            const { data } = await _supa.from('tickets_soporte').select('*').order('created_at', {ascending: false});
            document.getElementById('tickets-list').innerHTML = data.map(tk => `
                <div class="glass p-5 rounded-lg border-b ${tk.leido ? 'opacity-50' : 'border-amber-500/30'}">
                    <div class="flex justify-between items-start mb-3">
                        <h5 class="font-bold text-amber-500 text-sm uppercase">${tk.asunto}</h5>
                        <span class="text-[9px] text-zinc-600">${new Date(tk.created_at).toLocaleString()}</span>
                    </div>
                    <p class="text-xs text-zinc-300 leading-relaxed">${tk.mensaje}</p>
                    <button onclick="markRead('${tk.id}')" class="mt-4 text-[9px] font-black uppercase text-zinc-500 hover:text-white">Marcar como le√≠do</button>
                </div>
            `).join('');
        }

        async function markRead(id) {
            await _supa.from('tickets_soporte').update({leido: true}).eq('id', id);
            loadTickets();
        }
    </script>
</body>
</html>
