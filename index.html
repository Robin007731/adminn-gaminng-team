<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA ADMIN | RECOVERY</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #030508; color: #e0e6ed; font-family: sans-serif; }
        #loading-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #111; border-top-color: #00f2ff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .card { background: #0d1117; border: 1px solid #1a1f26; padding: 20px; border-radius: 8px; margin: 10px; }
        header { background: #0d1117; padding: 15px; border-bottom: 2px solid #00f2ff; display: flex; justify-content: space-between; }
        button { cursor: pointer; padding: 10px; font-family: 'Orbitron'; font-size: 0.7rem; border-radius: 4px; border: none; }
        .btn-neon { background: #00f2ff; color: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: #00f2ff; font-size: 0.7rem; padding: 10px; border-bottom: 1px solid #222; }
        td { padding: 10px; border-bottom: 1px solid #111; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="load-msg" style="font-family:'Orbitron'; margin-top:20px;">INICIANDO SESIÓN...</p>
        <div id="emergency-btns" style="display:none; margin-top:20px;">
            <button onclick="location.href='index.html'" style="background:#333; color:#fff;">VOLVER AL LOGIN</button>
            <button onclick="location.reload()" style="background:#00f2ff; color:#000;">REINTENTAR</button>
        </div>
    </div>

    <header>
        <div style="font-family:'Orbitron'; color:#00f2ff;">CORE_ADMIN</div>
        <button onclick="window.handleLogout()" style="background:#ff3131; color:#fff;">LOGOUT</button>
    </header>

    <div style="max-width: 1000px; margin: 20px auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="card">
            <h3 style="font-family:'Orbitron'; font-size:0.8rem;">ANUNCIO SISTEMA</h3>
            <textarea id="msg-input" style="width:100%; background:#000; color:#fff; border:1px solid #333; padding:10px;"></textarea>
            <button onclick="window.sendBroadcast()" class="btn-neon" style="margin-top:10px; width:100%;">ENVIAR A TODOS</button>
        </div>
        
        <div class="card">
            <h3 style="font-family:'Orbitron'; font-size:0.8rem;">ESTADÍSTICAS</h3>
            <p>Usuarios: <span id="user-count">0</span></p>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
            <h3 style="font-family:'Orbitron'; font-size:0.8rem;">LISTA DE OPERATIVOS</h3>
            <table>
                <thead>
                    <tr><th>NICK</th><th>PUNTOS</th><th>ACCIONES</th></tr>
                </thead>
                <tbody id="user-list"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, updateDoc, increment, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAyGsnbyvxTEzvtgOXSmU_5Hj6gS6TOWKM",
            authDomain: "gaming-team-18b95.firebaseapp.com",
            projectId: "gaming-team-18b95",
            storageBucket: "gaming-team-18b95.appspot.com",
            messagingSenderId: "89183017486",
            appId: "1:89183017486:web:18b6258a2bf5c0bde97a5f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Timer de emergencia: Si en 6 segundos no carga, mostrar botones
        setTimeout(() => {
            if(document.getElementById('loading-overlay').style.display !== 'none') {
                document.getElementById('load-msg').innerText = "ERROR: TIEMPO DE ESPERA AGOTADO";
                document.getElementById('emergency-btns').style.display = 'block';
            }
        }, 6000);

        onAuthStateChanged(auth, async (user) => {
            const msg = document.getElementById('load-msg');
            if (user) {
                msg.innerText = "BUSCANDO CREDENCIALES...";
                try {
                    const snap = await getDoc(doc(db, "usuarios", user.uid));
                    if (snap.exists() && snap.data().admin === true) {
                        document.getElementById('loading-overlay').style.display = 'none';
                        loadUsers();
                    } else {
                        msg.innerHTML = "<span style='color:red'>ACCESO DENEGADO</span><br>No tienes rango admin en Firestore.";
                        document.getElementById('emergency-btns').style.display = 'block';
                    }
                } catch (err) {
                    msg.innerText = "ERROR DE FIRESTORE: Revisa las reglas.";
                    document.getElementById('emergency-btns').style.display = 'block';
                }
            } else {
                window.location.href = "index.html";
            }
        });

        function loadUsers() {
            onSnapshot(collection(db, "usuarios"), (snap) => {
                const list = document.getElementById('user-list');
                document.getElementById('user-count').innerText = snap.size;
                list.innerHTML = "";
                snap.forEach(d => {
                    const u = d.data();
                    list.innerHTML += `
                        <tr>
                            <td>${u.nick}</td>
                            <td style="color:#39FF14">${u.puntos} XP</td>
                            <td>
                                <button onclick="window.updateXP('${d.id}', 100)" style="background:#222; color:#fff;">+100</button>
                                <button onclick="window.updateXP('${d.id}', -100)" style="background:#222; color:#fff;">-100</button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        // EXPORTAR FUNCIONES A WINDOW PARA LOS BOTONES
        window.updateXP = async (id, qty) => {
            await updateDoc(doc(db, "usuarios", id), { puntos: increment(qty) });
        };

        window.sendBroadcast = async () => {
            const val = document.getElementById('msg-input').value;
            if(!val) return;
            await addDoc(collection(db, "chat_global"), {
                nick: "SYSTEM", text: val.toUpperCase(), role: "admin", timestamp: serverTimestamp()
            });
            document.getElementById('msg-input').value = "";
            alert("ENVIADO");
        };

        window.handleLogout = () => signOut(auth).then(() => location.href='index.html');
    </script>
</body>
</html>
