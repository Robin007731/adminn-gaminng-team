<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA ADMIN | RECOVERY</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #030508; color: #e0e6ed; font-family: sans-serif; }
        #loading-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #111; border-top-color: #00f2ff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .card { background: #0d1117; border: 1px solid #1a1f26; padding: 20px; border-radius: 8px; margin: 10px; }
        header { background: #0d1117; padding: 15px; border-bottom: 2px solid #00f2ff; display: flex; justify-content: space-between; align-items:center; }
        button { cursor: pointer; padding: 10px; font-family: 'Orbitron'; font-size: 0.7rem; border-radius: 4px; border: none; }
        .btn-neon { background: #00f2ff; color: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: #00f2ff; font-size: 0.7rem; padding: 10px; border-bottom: 1px solid #222; }
        td { padding: 10px; border-bottom: 1px solid #111; font-size: 0.8rem; }
        .muted { color: #9aa6b2; }
        .small { font-size: 0.75rem; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="load-msg" style="font-family:'Orbitron'; margin-top:20px;">INICIANDO SESIÓN...</p>
        <div id="emergency-btns" style="display:none; margin-top:20px;">
            <button id="back-login" style="background:#333; color:#fff;">VOLVER AL LOGIN</button>
            <button id="retry" style="background:#00f2ff; color:#000;">REINTENTAR</button>
        </div>
    </div>

    <header>
        <div style="font-family:'Orbitron'; color:#00f2ff;">CORE_ADMIN</div>
        <button id="logout-btn" style="background:#ff3131; color:#fff;">LOGOUT</button>
    </header>

    <div style="max-width: 1000px; margin: 20px auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="card">
            <h3 style="font-family:'Orbitron'; font-size:0.8rem;">ANUNCIO SISTEMA</h3>
            <textarea id="msg-input" style="width:100%; background:#000; color:#fff; border:1px solid #333; padding:10px;"></textarea>
            <button id="send-broadcast" class="btn-neon" style="margin-top:10px; width:100%;">ENVIAR A TODOS</button>
        </div>
        
        <div class="card">
            <h3 style="font-family:'Orbitron'; font-size:0.8rem;">ESTADÍSTICAS</h3>
            <p>Usuarios: <span id="user-count">0</span></p>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
            <h3 style="font-family:'Orbitron'; font-size:0.8rem;">LISTA DE OPERATIVOS</h3>
            <table>
                <thead>
                    <tr><th>NICK</th><th>PUNTOS</th><th>ACCIONES</th></tr>
                </thead>
                <tbody id="user-list"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, updateDoc, increment, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAyGsnbyvxTEzvtgOXSmU_5Hj6gS6TOWKM",
            authDomain: "gaming-team-18b95.firebaseapp.com",
            projectId: "gaming-team-18b95",
            storageBucket: "gaming-team-18b95.appspot.com",
            messagingSenderId: "89183017486",
            appId: "1:89183017486:web:18b6258a2bf5c0bde97a5f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Referencias DOM
        const overlay = document.getElementById('loading-overlay');
        const loadMsg = document.getElementById('load-msg');
        const emergencyBtns = document.getElementById('emergency-btns');
        const backLoginBtn = document.getElementById('back-login');
        const retryBtn = document.getElementById('retry');
        const logoutBtn = document.getElementById('logout-btn');
        const sendBroadcastBtn = document.getElementById('send-broadcast');
        const msgInput = document.getElementById('msg-input');
        const userCountEl = document.getElementById('user-count');
        const userList = document.getElementById('user-list');

        // Timer de emergencia: Si en 6 segundos no carga, mostrar botones
        setTimeout(() => {
            const style = getComputedStyle(overlay);
            if (style.display !== 'none') {
                loadMsg.innerText = "ERROR: TIEMPO DE ESPERA AGOTADO";
                emergencyBtns.style.display = 'block';
            }
        }, 6000);

        backLoginBtn.addEventListener('click', () => location.href = 'index.html');
        retryBtn.addEventListener('click', () => location.reload());

        // Estado de autenticación
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                loadMsg.innerText = "BUSCANDO CREDENCIALES...";
                try {
                    const snap = await getDoc(doc(db, "usuarios", user.uid));
                    if (snap.exists() && snap.data().admin === true) {
                        overlay.style.display = 'none';
                        // Cargar lista de usuarios y sus cambios en tiempo real
                        loadUsers();
                    } else {
                        loadMsg.innerHTML = "<span style='color:red'>ACCESO DENEGADO</span><br>No tienes rango admin en Firestore.";
                        emergencyBtns.style.display = 'block';
                    }
                } catch (err) {
                    console.error("Firestore error:", err);
                    loadMsg.innerText = "ERROR DE FIRESTORE: Revisa las reglas o la conexión.";
                    emergencyBtns.style.display = 'block';
                }
            } else {
                // No autenticado -> volver al login
                window.location.href = "index.html";
            }
        });

        // Crea una fila segura en la tabla de usuarios (evita innerHTML)
        function createUserRow(docSnap) {
            const u = docSnap.data();
            const tr = document.createElement('tr');

            const nickTd = document.createElement('td');
            nickTd.textContent = u.nick ?? '(sin nick)';
            tr.appendChild(nickTd);

            const puntosTd = document.createElement('td');
            puntosTd.textContent = `${u.puntos ?? 0} XP`;
            puntosTd.style.color = '#39FF14';
            tr.appendChild(puntosTd);

            const actionsTd = document.createElement('td');

            const btnPlus = document.createElement('button');
            btnPlus.textContent = '+100';
            btnPlus.style.background = '#222';
            btnPlus.style.color = '#fff';
            btnPlus.className = 'small';
            btnPlus.addEventListener('click', async () => {
                btnPlus.disabled = true;
                btnMinus.disabled = true;
                try {
                    await updateXP(docSnap.id, 100);
                } catch (err) {
                    alert('Error al actualizar puntos: ' + err.message);
                } finally {
                    btnPlus.disabled = false;
                    btnMinus.disabled = false;
                }
            });

            const btnMinus = document.createElement('button');
            btnMinus.textContent = '-100';
            btnMinus.style.background = '#222';
            btnMinus.style.color = '#fff';
            btnMinus.className = 'small';
            btnMinus.addEventListener('click', async () => {
                btnPlus.disabled = true;
                btnMinus.disabled = true;
                try {
                    await updateXP(docSnap.id, -100);
                } catch (err) {
                    alert('Error al actualizar puntos: ' + err.message);
                } finally {
                    btnPlus.disabled = false;
                    btnMinus.disabled = false;
                }
            });

            actionsTd.appendChild(btnPlus);
            actionsTd.appendChild(document.createTextNode(' '));
            actionsTd.appendChild(btnMinus);
            tr.appendChild(actionsTd);

            return tr;
        }

        function loadUsers() {
            onSnapshot(collection(db, "usuarios"), (snap) => {
                userList.innerHTML = ""; // limpiar
                userCountEl.innerText = snap.size;
                snap.forEach(d => {
                    const row = createUserRow(d);
                    userList.appendChild(row);
                });
            }, (err) => {
                console.error('Error escuchando usuarios:', err);
                alert('No se pudo cargar la lista de usuarios.');
            });
        }

        // Funciones expuestas y seguras
        window.updateXP = async (id, qty) => {
            try {
                // opcional: prevenir que puntos queden negativos, si lo deseas hay que leer el doc primero
                await updateDoc(doc(db, "usuarios", id), { puntos: increment(qty) });
            } catch (err) {
                console.error('updateXP error:', err);
                throw err;
            }
        };

        sendBroadcastBtn.addEventListener('click', async () => {
            const val = msgInput.value.trim();
            if (!val) {
                alert('Escribe un mensaje antes de enviar.');
                return;
            }
            sendBroadcastBtn.disabled = true;
            try {
                await addDoc(collection(db, "chat_global"), {
                    nick: "SYSTEM", text: val.toUpperCase(), role: "admin", timestamp: serverTimestamp()
                });
                msgInput.value = "";
                alert("ENVIADO");
            } catch (err) {
                console.error('sendBroadcast error:', err);
                alert('Error al enviar broadcast: ' + err.message);
            } finally {
                sendBroadcastBtn.disabled = false;
            }
        });

        window.handleLogout = async () => {
            logoutBtn.disabled = true;
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (err) {
                console.error('Logout error:', err);
                alert('Error al hacer logout: ' + err.message);
            } finally {
                logoutBtn.disabled = false;
            }
        };
        logoutBtn.addEventListener('click', () => window.handleLogout());

    </script>
</body>
</html>
