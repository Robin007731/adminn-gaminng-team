<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZONA GAMER | Panel Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #7289da; --bg: #05070a; --accent: #00ff88; --card: #1a1d24; }
        body { font-family: 'Rajdhani', sans-serif; background: var(--bg); color: white; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid #333; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input, textarea, select { 
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; 
            background: #000; color: white; box-sizing: border-box; font-family: 'Rajdhani'; font-size: 16px;
        }
        button { 
            width: 100%; padding: 15px; background: var(--primary); border: none; color: white; 
            font-weight: bold; border-radius: 10px; cursor: pointer; text-transform: uppercase; font-family: 'Rajdhani'; font-size: 16px;
        }
        .btn-finish { background: #ff4d4d; width: auto; padding: 8px 15px; font-size: 14px; }
        .tournament-item { border-bottom: 1px solid #333; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .points-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        label { font-size: 14px; color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1 style="color: var(--accent); text-align: center; text-shadow: 0 0 15px var(--accent);">ðŸ‘‘ ZONA GAMER ADMIN</h1>

        <div class="card">
            <h3 style="margin-top:0;">ðŸš€ PUBLICAR NUEVO TORNEO</h3>
            <input type="text" id="t-name" placeholder="Nombre del Torneo (Ej: Copa Warzone)">
            <textarea id="t-desc" placeholder="Reglas o descripciÃ³n corta"></textarea>
            <input type="number" id="t-cap" placeholder="Cupos mÃ¡ximos">
            
            <p style="font-size: 14px; margin: 10px 0 5px 0; color: #888;">PUNTOS PREMIO POR PUESTO:</p>
            <div class="points-grid">
                <div><label>1Â°</label><input type="number" id="p1" value="100"></div>
                <div><label>2Â°</label><input type="number" id="p2" value="50"></div>
                <div><label>3Â°</label><input type="number" id="p3" value="25"></div>
            </div>
            
            <button onclick="createTournament()">PUBLICAR AHORA</button>
        </div>

        <div class="card">
            <h3>ðŸŽ® TORNEOS EN CURSO</h3>
            <div id="active-list">Buscando torneos activos...</div>
        </div>
    </div>

    <div id="finish-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); padding:20px; box-sizing:border-box; z-index:1000; overflow-y: auto;">
        <div class="card" style="max-width: 500px; margin: 40px auto;">
            <h2 style="color:var(--accent); text-align:center;">FINALIZAR TORNEO</h2>
            <p id="finish-title" style="text-align:center; font-weight:bold;"></p>
            <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
            
            <label>ðŸ¥‡ PRIMER PUESTO (GANADOR):</label>
            <select id="winner1"></select>
            
            <label>ðŸ¥ˆ SEGUNDO PUESTO:</label>
            <select id="winner2"></select>
            
            <label>ðŸ¥‰ TERCER PUESTO:</label>
            <select id="winner3"></select>
            
            <button onclick="submitResults()" style="background: var(--accent); color: black;">CONFIRMAR Y ENTREGAR PUNTOS</button>
            <button onclick="closeModal()" style="background:none; border:1px solid #444; margin-top:10px;">CANCELAR</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://oeczrnwfuqsifthqvktp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lY3pybndmdXFzaWZ0aHF2a3RwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzOTI2NTEsImV4cCI6MjA4NDk2ODY1MX0.j9juk2V3p_BGwz--P4foShZ3aBj28q7L41Va95aP2VQ'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentTournamentId = null;
        let pointsToGive = { p1: 0, p2: 0, p3: 0 };

        async function createTournament() {
            const name = document.getElementById('t-name').value;
            const description = document.getElementById('t-desc').value;
            const capacity = document.getElementById('t-cap').value;
            const p1 = document.getElementById('p1').value;
            const p2 = document.getElementById('p2').value;
            const p3 = document.getElementById('p3').value;

            if(!name || !p1) return alert("Por favor, pon al menos el nombre y puntos.");

            const { error } = await _supabase.from('tournaments').insert([{
                name, 
                description, 
                capacity, 
                points_json: { p1, p2, p3 }, 
                status: 'active'
            }]);

            if(error) alert("Error: " + error.message);
            else { alert("Â¡Torneo publicado!"); location.reload(); }
        }

        async function loadActive() {
            const { data, error } = await _supabase.from('tournaments').select('*').eq('status', 'active');
            if(error) { console.error(error); return; }
            
            const list = document.getElementById('active-list');
            list.innerHTML = data.map(t => `
                <div class="tournament-item">
                    <span><strong>${t.name}</strong></span>
                    <button class="btn-finish" onclick="openFinish('${t.id}', '${t.name}', ${JSON.stringify(t.points_json)})">CERRAR Y DAR PUNTOS</button>
                </div>
            `).join('') || "No hay torneos activos.";
        }

        async function openFinish(id, name, points) {
            currentTournamentId = id;
            pointsToGive = points;
            document.getElementById('finish-title').innerText = name;
            
            const { data: users } = await _supabase.from('profiles').select('id, username');
            const options = '<option value="">-- Seleccionar Jugador --</option>' + 
                          users.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
            
            document.getElementById('winner1').innerHTML = options;
            document.getElementById('winner2').innerHTML = options;
            document.getElementById('winner3').innerHTML = options;
            
            document.getElementById('finish-modal').style.display = 'block';
        }

        async function submitResults() {
            const winners = [
                { id: document.getElementById('winner1').value, pts: pointsToGive.p1 },
                { id: document.getElementById('winner2').value, pts: pointsToGive.p2 },
                { id: document.getElementById('winner3').value, pts: pointsToGive.p3 }
            ];

            if(!winners[0].id) return alert("Debes seleccionar al menos el 1Â° Puesto");

            for (const winner of winners) {
                if(winner.id) {
                    const { data: prof } = await _supabase.from('profiles').select('puntos').eq('id', winner.id).single();
                    const nuevosPuntos = (prof.puntos || 0) + parseInt(winner.pts);
                    await _supabase.from('profiles').update({ puntos: nuevosPuntos }).eq('id', winner.id);
                }
            }

            await _supabase.from('tournaments').update({ status: 'finished' }).eq('id', currentTournamentId);
            alert("Â¡Torneo finalizado con Ã©xito!");
            location.reload();
        }

        function closeModal() { document.getElementById('finish-modal').style.display = 'none'; }
        
        loadActive();
    </script>
</body>
</html>
