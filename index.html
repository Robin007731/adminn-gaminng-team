<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZONA GAMER | Panel Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #7289da; --bg: #05070a; --accent: #00ff88; --card: #1a1d24; }
        body { font-family: 'Rajdhani', sans-serif; background: var(--bg); color: white; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #333; margin-bottom: 20px; }
        input, textarea, select { 
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; 
            background: #000; color: white; box-sizing: border-box; font-family: 'Rajdhani';
        }
        button { 
            width: 100%; padding: 15px; background: var(--primary); border: none; color: white; 
            font-weight: bold; border-radius: 10px; cursor: pointer; text-transform: uppercase;
        }
        .btn-finish { background: #ff4d4d; margin-top: 10px; }
        .tournament-item { border-bottom: 1px solid #333; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .points-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h1 style="color: var(--accent);">ðŸ‘‘ PANEL ADMINISTRADOR</h1>

        <div class="card">
            <h3>NUEVO TORNEO</h3>
            <input type="text" id="t-name" placeholder="Nombre del Torneo">
            <textarea id="t-desc" placeholder="DescripciÃ³n / Reglas"></textarea>
            <input type="number" id="t-cap" placeholder="Cupos (Jugadores)">
            
            <p style="font-size: 14px; margin: 10px 0 0 0;">PUNTOS POR PUESTO:</p>
            <div class="points-grid">
                <input type="number" id="p1" placeholder="1Â° Lugar">
                <input type="number" id="p2" placeholder="2Â° Lugar">
                <input type="number" id="p3" placeholder="3Â° Lugar">
            </div>
            
            <button onclick="createTournament()">ðŸš€ PUBLICAR TORNEO AL INSTANTE</button>
        </div>

        <div class="card">
            <h3>GESTIONAR TORNEOS ACTIVOS</h3>
            <div id="active-list">Cargando...</div>
        </div>
    </div>

    <div id="finish-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); padding:20px; box-sizing:border-box; z-index:1000;">
        <div class="card">
            <h2 style="color:var(--accent);">FINALIZAR Y ASIGNAR PUNTOS</h2>
            <p id="finish-title"></p>
            
            <label>1Â° PUESTO (GANADOR):</label>
            <select id="winner1"></select>
            
            <label>2Â° PUESTO:</label>
            <select id="winner2"></select>
            
            <label>3Â° PUESTO:</label>
            <select id="winner3"></select>
            
            <button onclick="submitResults()">CONFIRMAR RESULTADOS Y DAR PUNTOS</button>
            <button onclick="closeModal()" style="background:none;">CANCELAR</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://oeczrnwfuqsifthqvktp.supabase.co';
        const SUPABASE_KEY = 'TU_KEY_ANON_AQUI'; // USA LA MISMA QUE EN EL CLIENTE
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentTournamentId = null;
        let pointsToGive = { p1: 0, p2: 0, p3: 0 };

        // 1. Crear Torneo
        async function createTournament() {
            const name = document.getElementById('t-name').value;
            const description = document.getElementById('t-desc').value;
            const capacity = document.getElementById('t-cap').value;
            const p1 = document.getElementById('p1').value;
            const p2 = document.getElementById('p2').value;
            const p3 = document.getElementById('p3').value;

            if(!name || !p1) return alert("Completa los datos");

            const { error } = await _supabase.from('tournaments').insert([{
                name, description, capacity, 
                points_json: { p1, p2, p3 }, // Guardamos los puntos en un JSON
                status: 'active'
            }]);

            if(error) alert(error.message);
            else {
                alert("Â¡Torneo publicado!");
                location.reload();
            }
        }

        // 2. Cargar Torneos Activos
        async function loadActive() {
            const { data } = await _supabase.from('tournaments').select('*').eq('status', 'active');
            const list = document.getElementById('active-list');
            list.innerHTML = data.map(t => `
                <div class="tournament-item">
                    <span>${t.name}</span>
                    <button class="btn-finish" onclick="openFinish('${t.id}', '${t.name}', ${JSON.stringify(t.points_json)})">FINALIZAR</button>
                </div>
            `).join('') || "No hay torneos activos.";
        }

        // 3. Abrir Modal de Cierre
        async function openFinish(id, name, points) {
            currentTournamentId = id;
            pointsToGive = points;
            document.getElementById('finish-title').innerText = "Torneo: " + name;
            
            // Cargar usuarios para el SELECT
            const { data: users } = await _supabase.from('profiles').select('id, username');
            const selects = ['winner1', 'winner2', 'winner3'];
            
            selects.forEach(s => {
                const el = document.getElementById(s);
                el.innerHTML = '<option value="">Selecciona un jugador</option>' + 
                    users.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
            });
            
            document.getElementById('finish-modal').style.display = 'block';
        }

        // 4. Procesar Resultados y Sumar Puntos
        async function submitResults() {
            const w1 = document.getElementById('winner1').value;
            const w2 = document.getElementById('winner2').value;
            const w3 = document.getElementById('winner3').value;

            if(!w1) return alert("MÃ­nimo debes poner al ganador");

            // FunciÃ³n para sumar puntos a un perfil (debes tener la columna 'puntos' en tu tabla profiles)
            const addPoints = async (userId, pts) => {
                if(!userId) return;
                // Obtenemos puntos actuales
                const { data } = await _supabase.from('profiles').select('puntos').eq('id', userId).single();
                const total = (data.puntos || 0) + parseInt(pts);
                await _supabase.from('profiles').update({ puntos: total }).eq('id', userId);
            };

            await addPoints(w1, pointsToGive.p1);
            await addPoints(w2, pointsToGive.p2);
            await addPoints(w3, pointsToGive.p3);

            // Marcamos torneo como finalizado
            await _supabase.from('tournaments').update({ status: 'finished' }).eq('id', currentTournamentId);

            alert("Â¡Resultados publicados y puntos asignados!");
            location.reload();
        }

        function closeModal() { document.getElementById('finish-modal').style.display = 'none'; }

        loadActive();
    </script>
</body>
</html>
