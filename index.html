<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE CONTROL TOTAL | ZONA GAMER</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root { 
            --neon: #00f2ff; --bg: #030508; --card: #0d1117; 
            --error: #ff3131; --gold: #ffd700; --success: #39FF14;
        }
        
        * { box-sizing: border-box; }
        body { 
            margin: 0; background: var(--bg); color: #e0e6ed; 
            font-family: 'Rajdhani', sans-serif; overflow-x: hidden;
        }

        /* Header Estilo Cyberpunk */
        header { 
            background: var(--card); padding: 20px; border-bottom: 2px solid var(--neon); 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
        }

        /* Layout Grid */
        .grid-container { 
            display: grid; grid-template-columns: 350px 1fr 350px; gap: 20px; padding: 20px; 
        }
        @media (max-width: 1100px) { .grid-container { grid-template-columns: 1fr; } }

        /* Tarjetas */
        .card { 
            background: var(--card); border: 1px solid #1a1f26; padding: 20px; 
            border-radius: 8px; margin-bottom: 20px; position: relative;
        }
        .card-title { 
            font-family: 'Orbitron'; font-size: 0.8rem; color: var(--neon); 
            margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 10px;
            display: flex; justify-content: space-between;
        }

        /* Inputs y Botones */
        input, textarea, select { 
            width: 100%; padding: 12px; background: #000; border: 1px solid #222; 
            color: #fff; margin-bottom: 15px; font-family: 'Fira Code'; border-radius: 4px;
        }
        .btn { 
            width: 100%; padding: 12px; background: var(--neon); border: none; 
            font-family: 'Orbitron'; font-weight: bold; cursor: pointer; 
            border-radius: 4px; transition: 0.3s; color: #000; text-transform: uppercase;
        }
        .btn:hover { filter: brightness(1.2); box-shadow: 0 0 15px var(--neon); }
        .btn-danger { background: var(--error); color: #fff; font-size: 0.7rem; padding: 5px; }

        /* Tabla de Usuarios */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: #444; font-family: 'Orbitron'; font-size: 0.6rem; padding: 10px; }
        td { padding: 12px 10px; border-bottom: 1px solid #0a0e14; }
        
        .xp-badge { color: var(--success); font-weight: bold; font-family: 'Fira Code'; }
        
        /* Ranking */
        .rank-row { 
            display: flex; align-items: center; padding: 10px; 
            background: rgba(255,255,255,0.02); margin-bottom: 10px; border-radius: 5px;
        }
        .rank-pos { font-family: 'Orbitron'; font-size: 1.2rem; margin-right: 15px; min-width: 30px; }
        
        .winner-item { 
            padding: 8px; border-left: 3px solid var(--gold); 
            background: #1a1f26; margin-bottom: 8px; font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <header>
        <div style="font-family:'Orbitron'; letter-spacing:3px;">SYSTEM_<span style="color:var(--neon)">OVERRIDE</span>_v4</div>
        <div style="font-size: 0.7rem; color: var(--neon); font-family: 'Fira Code';">ACCESS_LEVEL: MASTER_ADMIN</div>
    </header>

    <div class="grid-container">
        
        <aside>
            <div class="card">
                <div class="card-title">DESPLEGAR TORNEO</div>
                <input type="text" id="m-name" placeholder="Nombre del Evento">
                <input type="number" id="m-cap" placeholder="Capacidad (ej. 32)">
                <textarea id="m-desc" rows="3" placeholder="Reglas y premios..."></textarea>
                <button class="btn" onclick="crearTorneo()">PUBLICAR EVENTO</button>
            </div>

            <div class="card">
                <div class="card-title">BROADCAST SYSTEM</div>
                <textarea id="sys-msg" rows="2" placeholder="Mensaje para el chat global..."></textarea>
                <button class="btn" onclick="enviarMensaje()">ENVIAR A TODOS</button>
            </div>

            <div class="card">
                <div class="card-title">LOG DE GANADORES</div>
                <div id="winners-list">
                    </div>
            </div>
        </aside>

        <main>
            <div class="card">
                <div class="card-title">DATABASE_OPERATIVOS [<span id="user-count">0</span>]</div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>JUGADOR</th>
                                <th>PUNTOS XP</th>
                                <th>MODIFICAR</th>
                                <th>ELIMINAR</th>
                            </tr>
                        </thead>
                        <tbody id="user-table">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>

        <aside>
            <div class="card">
                <div class="card-title">TOP 3 RANKING</div>
                <div id="ranking-container">
                    </div>
            </div>

            <div class="card">
                <div class="card-title">CORONAR GANADOR</div>
                <p style="font-size: 0.7rem; color: #666; margin-bottom: 10px;">Selecciona al operativo que gan√≥ el √∫ltimo evento:</p>
                <select id="win-selector">
                    <option value="">Cargando operativos...</option>
                </select>
                <button class="btn" style="background:var(--gold)" onclick="registrarGanador()">REGISTRAR VICTORIA</button>
            </div>
        </aside>

    </div>

    <script>
        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAyGsnbyvxTEzvtgOXSmU_5Hj6gS6TOWKM",
            authDomain: "gaming-team-18b95.firebaseapp.com",
            projectId: "gaming-team-18b95",
            storageBucket: "gaming-team-18b95.appspot.com",
            messagingSenderId: "89183017486",
            appId: "1:89183017486:web:18b6258a2bf5c0bde97a5f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- CARGA INICIAL Y REAL-TIME ---
        function sincronizarDatos() {
            // Escuchar Usuarios (Ordenados por puntos)
            db.collection("usuarios").orderBy("puntos", "desc").onSnapshot(snap => {
                const table = document.getElementById('user-table');
                const ranking = document.getElementById('ranking-container');
                const selector = document.getElementById('win-selector');
                
                document.getElementById('user-count').innerText = snap.size;
                
                table.innerHTML = "";
                ranking.innerHTML = "";
                selector.innerHTML = '<option value="">Seleccionar Jugador...</option>';

                let i = 1;
                snap.forEach(doc => {
                    const u = doc.data();
                    const id = doc.id;

                    // 1. Llenar Tabla Principal
                    table.innerHTML += `
                        <tr>
                            <td><b>${u.nick}</b><br><small style="color:#444">${u.whatsapp || 'No data'}</small></td>
                            <td class="xp-badge">${u.puntos || 0} XP</td>
                            <td>
                                <button onclick="modXP('${id}', 100)" style="cursor:pointer; background:#222; color:white; border:none; padding:5px;">+100</button>
                                <button onclick="modXP('${id}', -100)" style="cursor:pointer; background:#222; color:white; border:none; padding:5px;">-100</button>
                            </td>
                            <td>
                                <button class="btn btn-danger" onclick="eliminarOperativo('${id}')">BORRAR</button>
                            </td>
                        </tr>
                    `;

                    // 2. Llenar Ranking Top 3
                    if(i <= 3) {
                        const medal = i === 1 ? 'ü•á' : i === 2 ? 'ü•à' : 'ü•â';
                        ranking.innerHTML += `
                            <div class="rank-row">
                                <div class="rank-pos">${medal}</div>
                                <div><b>${u.nick}</b><br><small style="color:var(--neon)">${u.puntos} XP</small></div>
                            </div>
                        `;
                    }

                    // 3. Llenar Selector
                    selector.innerHTML += `<option value="${u.nick}">${u.nick}</option>`;
                    i++;
                });
            });

            // Escuchar Ganadores
            db.collection("ganadores").orderBy("fecha", "desc").limit(8).onSnapshot(snap => {
                const list = document.getElementById('winners-list');
                list.innerHTML = "";
                snap.forEach(doc => {
                    list.innerHTML += `<div class="winner-item">üèÜ ${doc.data().nick}</div>`;
                });
            });
        }

        // --- FUNCIONES DE ACCI√ìN ---

        // ELIMINAR (ESTRICTO)
        window.eliminarOperativo = function(id) {
            if(confirm("¬øELIMINAR ESTE PERFIL DEFINITIVAMENTE? No hay vuelta atr√°s.")) {
                db.collection("usuarios").doc(id).delete()
                .then(() => console.log("Eliminado con √©xito"))
                .catch(err => alert("Error al borrar: " + err.message));
            }
        };

        window.modXP = (id, val) => {
            db.collection("usuarios").doc(id).update({
                puntos: firebase.firestore.FieldValue.increment(val)
            });
        };

        window.crearTorneo = () => {
            const n = document.getElementById('m-name').value;
            const c = document.getElementById('m-cap').value;
            const d = document.getElementById('m-desc').value;
            if(!n || !c) return alert("Ingresa nombre y capacidad");
            
            db.collection("torneos").add({
                nombre: n,
                capacidad: parseInt(c),
                desc: d,
                active: true,
                jugadores: [],
                inscritos_count: 0,
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert("Torneo desplegado");
                document.getElementById('m-name').value = "";
                document.getElementById('m-cap').value = "";
                document.getElementById('m-desc').value = "";
            });
        };

        window.enviarMensaje = () => {
            const txt = document.getElementById('sys-msg').value;
            if(!txt) return;
            db.collection("chat_global").add({
                nick: "SYSTEM",
                text: txt.toUpperCase(),
                role: "admin",
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => document.getElementById('sys-msg').value = "");
        };

        window.registrarGanador = () => {
            const n = document.getElementById('win-selector').value;
            if(!n) return alert("Selecciona un nombre");
            db.collection("ganadores").add({
                nick: n,
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => alert("Victoria registrada"));
        };

        // Iniciar todo
        sincronizarDatos();
    </script>
</body>
</html>
