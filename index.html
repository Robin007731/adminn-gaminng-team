<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZONA GAMER | CONTROL TOTAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root { --neon: #00f2ff; --bg: #020406; --card: #0a0e14; --error: #ff3131; }
        body { margin: 0; background: var(--bg); color: #e0e6ed; font-family: 'Rajdhani', sans-serif; }
        
        /* Pantalla de Carga */
        #loader { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spin { width: 50px; height: 50px; border: 3px solid #111; border-top: 3px solid var(--neon); border-radius: 50%; animation: s 1s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }

        /* Dashboard */
        header { background: var(--card); padding: 15px 30px; border-bottom: 2px solid var(--neon); display: flex; justify-content: space-between; align-items: center; }
        .main { max-width: 1200px; margin: 20px auto; padding: 0 20px; display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        @media (max-width: 900px) { .main { grid-template-columns: 1fr; } }

        .card { background: var(--card); border: 1px solid #1a1f26; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .title { font-family: 'Orbitron'; font-size: 0.7rem; color: var(--neon); margin-bottom: 15px; border-bottom: 1px solid #1a1f26; padding-bottom: 5px; }

        input, textarea { width: 100%; padding: 10px; background: #000; border: 1px solid #222; color: #fff; margin-bottom: 10px; border-radius: 4px; }
        .btn { width: 100%; padding: 12px; background: var(--neon); border: none; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; border-radius: 4px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 0.6rem; color: #555; text-transform: uppercase; padding: 10px; border-bottom: 1px solid #1a1f26; }
        td { padding: 12px 10px; border-bottom: 1px solid #05070a; font-size: 0.9rem; }
        .act { background: #111; border: 1px solid #333; color: #fff; padding: 5px 8px; cursor: pointer; border-radius: 3px; font-size: 0.7rem; }
        .act:hover { border-color: var(--neon); }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spin"></div>
        <p id="load-status" style="margin-top:20px; font-family:'Orbitron'; font-size:0.7rem;">SINCRONIZANDO...</p>
        <button id="btn-cancel" onclick="location.href='index.html'" style="display:none; margin-top:20px; background:none; color:#444; border:1px solid #222; cursor:pointer;">CANCELAR</button>
    </div>

    <header>
        <div style="font-family:'Orbitron'; letter-spacing:2px;">MASTER_<span style="color:var(--neon)">ADMIN</span></div>
        <button onclick="logout()" class="act" style="color:var(--error); border-color:var(--error)">CERRAR SESIÓN</button>
    </header>

    <div class="main">
        <aside>
            <div class="card">
                <div class="title">MENSAJE GLOBAL</div>
                <textarea id="sys-msg" rows="3" placeholder="Escribir a todos los usuarios..."></textarea>
                <button class="btn" onclick="sendMsg()">ENVIAR BROADCAST</button>
            </div>
            <div class="card">
                <div class="title">NUEVA MISIÓN</div>
                <input type="text" id="m-name" placeholder="Nombre de la misión">
                <textarea id="m-desc" placeholder="Reglas/Premios"></textarea>
                <button class="btn" onclick="createMission()">PUBLICAR</button>
            </div>
        </aside>

        <main>
            <div class="card">
                <div class="title">OPERATIVOS ACTIVOS (<span id="total-users">0</span>)</div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>NICKNAME</th>
                                <th>PUNTOS XP</th>
                                <th>ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="user-table"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const firebaseConfig = {
            apiKey: "AIzaSyAyGsnbyvxTEzvtgOXSmU_5Hj6gS6TOWKM",
            authDomain: "gaming-team-18b95.firebaseapp.com",
            projectId: "gaming-team-18b95",
            storageBucket: "gaming-team-18b95.appspot.com",
            messagingSenderId: "89183017486",
            appId: "1:89183017486:web:18b6258a2bf5c0bde97a5f"
        };

        // Inicializar
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const statusText = document.getElementById('load-status');

        // Mostrar botón de cancelar si tarda mucho
        setTimeout(() => document.getElementById('btn-cancel').style.display = 'block', 4000);

        // --- LÓGICA DE ACCESO ---
        auth.onAuthStateChanged(user => {
            if (user) {
                statusText.innerText = "COMPROBANDO RANGO...";
                db.collection("usuarios").doc(user.uid).get()
                .then(doc => {
                    if (doc.exists && doc.data().admin === true) {
                        document.getElementById('loader').style.display = 'none';
                        initDashboard();
                    } else {
                        statusText.style.color = "red";
                        statusText.innerText = "ERROR: NO TIENES PERMISOS DE ADMIN";
                    }
                })
                .catch(err => {
                    statusText.innerText = "ERROR DE LECTURA: " + err.message;
                });
            } else {
                window.location.href = 'index.html';
            }
        });

        // --- DASHBOARD ---
        function initDashboard() {
            // Escuchar usuarios en tiempo real
            db.collection("usuarios").onSnapshot(snap => {
                const table = document.getElementById('user-table');
                document.getElementById('total-users').innerText = snap.size;
                table.innerHTML = "";
                snap.forEach(doc => {
                    const u = doc.data();
                    table.innerHTML += `
                        <tr>
                            <td><b>${u.nick}</b><br><small style="color:#444">${doc.id}</small></td>
                            <td style="color:var(--neon); font-weight:bold;">${u.puntos || 0} XP</td>
                            <td>
                                <button class="act" onclick="modifyXP('${doc.id}', 100)">+100</button>
                                <button class="act" onclick="modifyXP('${doc.id}', -100)">-100</button>
                                <button class="act" onclick="deleteUser('${doc.id}')" style="color:var(--error)">DEL</button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        // --- FUNCIONES DE ACCIÓN ---
        window.modifyXP = (id, amt) => {
            db.collection("usuarios").doc(id).update({
                puntos: firebase.firestore.FieldValue.increment(amt)
            });
        };

        window.deleteUser = (id) => {
            if(confirm("¿ELIMINAR ESTE USUARIO?")) {
                db.collection("usuarios").doc(id).delete();
            }
        };

        window.sendMsg = () => {
            const txt = document.getElementById('sys-msg').value;
            if(!txt) return;
            db.collection("chat_global").add({
                nick: "SYSTEM",
                text: txt.toUpperCase(),
                role: "admin",
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('sys-msg').value = "";
                alert("Broadcast enviado");
            });
        };

        window.createMission = () => {
            const n = document.getElementById('m-name').value;
            const d = document.getElementById('m-desc').value;
            if(!n) return;
            db.collection("torneos").add({
                nombre: n,
                desc: d,
                inscritos_count: 0,
                jugadores: [],
                active: true
            }).then(() => {
                document.getElementById('m-name').value = "";
                document.getElementById('m-desc').value = "";
                alert("Misión desplegada");
            });
        };

        window.logout = () => auth.signOut();
    </script>
</body>
</html>
